<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <title>G-SOFT | Management</title>
  <style>
    :root{
      --bg: #070b12;
      --bg2:#0b1220;
      --card:#0f1a2f;
      --card2:#0c1628;
      --text:#e8eefc;
      --muted:#9db0d0;
      --border: rgba(255,255,255,.08);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --primary:#22c55e;
      --primary2:#0ea5e9;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;

      --radius: 18px;
      --radius2: 22px;
      --blur: 16px;

      --sidebarW: 290px;
      --topbarH: 64px;
      --gap: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    [data-theme="light"]{
      --bg:#f5f7fb;
      --bg2:#ffffff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#0b1220;
      --muted:#55627b;
      --border: rgba(13,27,54,.10);
      --shadow: 0 18px 50px rgba(13,27,54,.12);
      --primary:#16a34a;
      --primary2:#0284c7;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(1000px 600px at 85% 25%, rgba(14,165,233,.14), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      overflow:hidden;
    }

    /* -------- Scrollbars (brand) -------- */
    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(34,197,94,.55) rgba(255,255,255,.08);
    }
    *::-webkit-scrollbar{height:10px;width:10px}
    *::-webkit-scrollbar-track{background: rgba(255,255,255,.08); border-radius: 999px}
    *::-webkit-scrollbar-thumb{background: rgba(34,197,94,.55); border-radius: 999px}
    *::-webkit-scrollbar-thumb:hover{background: rgba(34,197,94,.75)}

    /* -------- App layout -------- */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      grid-template-rows: var(--topbarH) 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar main";
      gap: 0;
    }

    .topbar{
      grid-area: topbar;
      height: var(--topbarH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 0;
    }
    .logo{
      width:38px;height:38px;border-radius: 14px;
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(14,165,233,.22));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .logo svg{opacity:.95}
    .brand-title{
      display:flex; flex-direction:column; line-height:1.12;
      min-width: 0;
    }
    .brand-title b{
      font-size: 14px; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand-title span{
      font-size: 12px; color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .top-actions{display:flex; align-items:center; gap:10px}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      backdrop-filter: blur(var(--blur));
      cursor: default;
      user-select:none;
      max-width: 240px;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--primary);
      box-shadow: 0 0 0 6px rgba(34,197,94,.18);
      flex:0 0 auto;
    }
    .pill .text{
      min-width:0;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.07)}
    .btn:active{transform: scale(.98)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.16), rgba(34,197,94,.06));
      border-color: rgba(34,197,94,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.18), rgba(239,68,68,.06));
      border-color: rgba(239,68,68,.35);
    }

    /* Theme toggle (sun/moon with animation) */
    .theme-toggle{
      width: 46px; height: 42px;
      border-radius: 16px;
      position:relative;
      overflow:hidden;
    }
    .theme-toggle .icon{
      width: 20px; height: 20px;
      position:absolute; top:50%; left:50%;
      transform: translate(-50%,-50%);
      transition: transform .25s ease, opacity .25s ease;
      opacity: 1;
    }
    [data-theme="dark"] .theme-toggle .sun{transform: translate(-50%,-50%) rotate(-35deg) scale(.7); opacity:.0}
    [data-theme="dark"] .theme-toggle .moon{transform: translate(-50%,-50%) rotate(0deg) scale(1); opacity:1}
    [data-theme="light"] .theme-toggle .sun{transform: translate(-50%,-50%) rotate(0deg) scale(1); opacity:1}
    [data-theme="light"] .theme-toggle .moon{transform: translate(-50%,-50%) rotate(35deg) scale(.7); opacity:.0}

    /* -------- Sidebar -------- */
    .sidebar{
      grid-area: sidebar;
      height: 100%;
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      padding: 18px 14px;
      display:flex; flex-direction:column;
      gap: 14px;
      overflow:hidden;
    }

    .nav{
      display:flex; flex-direction:column;
      gap: 6px;
      overflow:auto;
      padding-right: 6px;
    }

    .nav a{
      text-decoration:none;
      color: var(--text);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      border: 1px solid transparent;
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .nav a:hover{
      background: rgba(255,255,255,.05);
      border-color: var(--border);
    }
    .nav a:active{transform: scale(.99)}
    .nav a.active{
      background: linear-gradient(135deg, rgba(34,197,94,.14), rgba(14,165,233,.10));
      border-color: rgba(34,197,94,.28);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .nav .ico{
      width: 36px; height: 36px;
      border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      flex: 0 0 auto;
    }
    .nav .meta{min-width:0}
    .nav .meta b{display:block;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .nav .meta span{display:block;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* -------- Main -------- */
    .main{
      grid-area: main;
      height: calc(100vh - var(--topbarH));
      overflow:hidden;
    }
    .content{
      height:100%;
      padding: 18px;
      overflow:auto;
    }

    .grid{
      display:grid;
      gap: var(--gap);
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .card .hd b{font-size:14px}
    .card .hd span{font-size:12px;color:var(--muted)}
    .card .bd{padding: 16px}
    .muted{color:var(--muted)}
    .h1{font-size: 22px; margin:0 0 6px 0}
    .h2{font-size: 16px; margin:0 0 8px 0}
    .row{display:flex; gap: 10px; flex-wrap:wrap; align-items:center}

    /* -------- Inputs (brand, dark/light ok) -------- */
    .field{display:flex; flex-direction:column; gap:8px; min-width: 220px}
    .label{font-size:12px;color:var(--muted)}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      transition: border-color .12s ease, background .12s ease;
      appearance:none;
    }
    input:focus, select:focus{
      border-color: rgba(34,197,94,.45);
      background: rgba(255,255,255,.06);
    }

    /* custom select arrow */
    .select-wrap{position:relative}
    .select-wrap:after{
      content:"";
      position:absolute;
      right: 12px; top: 50%;
      width: 10px; height: 10px;
      transform: translateY(-50%) rotate(45deg);
      border-right: 2px solid rgba(157,176,208,.9);
      border-bottom: 2px solid rgba(157,176,208,.9);
      pointer-events:none;
      opacity:.8;
    }
    select{padding-right: 38px}

    /* -------- Login view -------- */
    .auth{
      height:100vh;
      display:grid;
      place-items:center;
      padding: 18px;
    }
    .auth-card{
      width: min(520px, 100%);
      border-radius: 26px;
    }
    .auth-inner{
      padding: 18px;
      display:grid;
      gap: 14px;
    }
    .auth-top{
      display:flex; align-items:center; gap: 12px;
    }
    .auth-top .logo{width:44px;height:44px;border-radius: 18px}
    .auth-actions{display:flex; gap:10px; justify-content:flex-end}
    .error{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color: #ffd7d7;
      font-size: 13px;
      display:none;
    }
    .error.show{display:block}

    /* -------- Mobile burger + drawer -------- */
    .burger{
      display:none;
      width: 46px; height: 42px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      align-items:center;
      justify-content:center;
    }
    .burger span, .burger span:before, .burger span:after{
      content:"";
      display:block;
      width: 18px; height: 2px;
      background: var(--text);
      border-radius: 99px;
      position: relative;
      transition: transform .2s ease, top .2s ease, opacity .2s ease;
      opacity:.9;
    }
    .burger span:before{position:absolute; top:-6px}
    .burger span:after{position:absolute; top:6px}

    .drawer-backdrop{
      display:none;
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 40;
    }
    .drawer{
      display:none;
      position: fixed;
      top:0; left:0;
      height:100vh;
      width: min(92vw, 330px);
      z-index: 50;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      transform: translateX(-105%);
      transition: transform .22s ease;
    }
    .drawer.open{transform: translateX(0)}
    .drawer-backdrop.open{display:block}
    .drawer-wrap{height:100%}

    /* -------- Loading overlay -------- */
    .loading{
      position: fixed; inset:0;
      display:none;
      z-index: 80;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .loading.show{display:flex}
    .loader{
      width: min(520px, 92vw);
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      padding: 16px;
      display:flex;
      gap: 14px;
      align-items:center;
    }
    .spinner{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.18);
      border-top-color: rgba(34,197,94,.85);
      animation: spin 1s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin{to{transform: rotate(360deg)}}
    .loader b{display:block; font-size: 14px}
    .loader span{display:block; font-size: 12px; color: var(--muted)}

    /* -------- Toast -------- */
    .toasts{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 90;
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-width: min(420px, 92vw);
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      animation: toastIn .18s ease;
    }
    @keyframes toastIn{from{transform: translateY(6px); opacity:0}to{transform: translateY(0); opacity:1}}
    .toast .tag{
      width:10px;height:10px;border-radius:999px;
      margin-top: 6px;
      flex:0 0 auto;
      background: var(--primary);
      box-shadow: 0 0 0 6px rgba(34,197,94,.16);
    }
    .toast.err .tag{background: var(--danger); box-shadow:0 0 0 6px rgba(239,68,68,.14)}
    .toast .t{
      min-width:0;
    }
    .toast .t b{display:block; font-size: 13px}
    .toast .t span{display:block; font-size: 12px; color: var(--muted)}
    .toast button{
      margin-left:auto;
      border:none;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 16px;
      line-height: 1;
    }

    /* -------- Responsive -------- */
    @media (max-width: 980px){
      .app{
        grid-template-columns: 1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{display:none}
      .burger{display:flex}
      .topbar{padding: 12px 14px}
      .content{padding: 14px}
      .pill{display:none}
    }
  </style>
</head>

<body data-theme="dark">
  <!-- Loading overlay (blocks all UI during API calls) -->
  <div id="loading" class="loading" aria-hidden="true">
    <div class="loader">
      <div class="spinner"></div>
      <div>
        <b id="loadingTitle">Yuklanmoqda‚Ä¶</b>
        <span id="loadingText">Ma‚Äôlumotlar olinmoqda, iltimos kuting.</span>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toasts"></div>

  <!-- Mobile drawer -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <div id="drawer" class="drawer">
    <div class="drawer-wrap sidebar">
      <div class="brand" style="padding: 4px 6px 10px 6px;">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 14c2.5 2.5 7.5 2.5 10 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 10c3.8-5.2 12.2-5.2 16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 21c-1.7-3.7-1.7-8.3 0-12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brand-title">
          <b>G-SOFT | Management</b>
          <span id="subBrand">ofis.gekto.uz</span>
        </div>
      </div>

      <nav id="navDrawer" class="nav"></nav>
    </div>
  </div>

  <!-- App root -->
  <div id="root"></div>

<script>
(() => {
  // ===== CONFIG =====
  const API_BASE = "https://api.ofis.gekto.uz";
  const DEFAULT_ROUTE = "#/tasks"; // <-- –∑–¥–µ—Å—å –º–µ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ (Vazifalar)

  // ===== STATE =====
  const state = {
    user: null,
    ui: {
      lang: "ru",
      theme: "dark",
      light: { primary: "#16a34a", bg: "#ffffff" },
      dark:  { primary: "#22c55e", bg: "#070b12" },
      font: "Inter"
    },
    dict: { cities: [], sources: [], services: [] },
    cacheReady: false
  };

  // ===== I18N =====
  const T = {
    ru: {
      main: "–ì–ª–∞–≤–Ω–∞—è",
      tasks: "Vazifalar",
      projects: "Loyihalar",
      courses: "Kurslar",
      clients: "Baza (Klientlar)",
      settings: "Sozlamalar",
      users: "Foydalanuvchilar",
      welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
      loginTitle: "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É",
      login: "–õ–æ–≥–∏–Ω",
      password: "–ü–∞—Ä–æ–ª—å",
      signIn: "–í–æ–π—Ç–∏",
      logout: "–í—ã–π—Ç–∏",
      loading: "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶",
      loading2: "–ò–¥—ë—Ç –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.",
    },
    uz: {
      main: "Asosiy",
      tasks: "Vazifalar",
      projects: "Loyihalar",
      courses: "Kurslar",
      clients: "Baza (Klientlar)",
      settings: "Sozlamalar",
      users: "Foydalanuvchilar",
      welcome: "Xush kelibsiz",
      loginTitle: "Tizimga kirish",
      login: "Login",
      password: "Parol",
      signIn: "Kirish",
      logout: "Chiqish",
      loading: "Yuklanmoqda‚Ä¶",
      loading2: "So‚Äòrov bajarilmoqda. Iltimos kuting.",
    },
    en: {
      main: "Main",
      tasks: "Tasks",
      projects: "Projects",
      courses: "Courses",
      clients: "Clients",
      settings: "Settings",
      users: "Users",
      welcome: "Welcome",
      loginTitle: "Sign in",
      login: "Login",
      password: "Password",
      signIn: "Sign in",
      logout: "Logout",
      loading: "Loading‚Ä¶",
      loading2: "Request in progress. Please wait.",
    }
  };

  const t = (key) => (T[state.ui.lang] && T[state.ui.lang][key]) || (T.ru[key] || key);

  // ===== UI helpers =====
  const $ = (sel, el=document) => el.querySelector(sel);
  const root = $("#root");
  const loadingEl = $("#loading");
  const loadingTitle = $("#loadingTitle");
  const loadingText = $("#loadingText");
  const toastsEl = $("#toasts");
  const drawer = $("#drawer");
  const drawerBackdrop = $("#drawerBackdrop");

  function showLoading(title, text){
    loadingTitle.textContent = title || t("loading");
    loadingText.textContent = text || t("loading2");
    loadingEl.classList.add("show");
    loadingEl.setAttribute("aria-hidden","false");
  }
  function hideLoading(){
    loadingEl.classList.remove("show");
    loadingEl.setAttribute("aria-hidden","true");
  }

  function toast(msg, desc="", type="ok"){
    const el = document.createElement("div");
    el.className = "toast" + (type==="err" ? " err" : "");
    el.innerHTML = `
      <div class="tag"></div>
      <div class="t">
        <b>${escapeHtml(msg)}</b>
        ${desc ? `<span>${escapeHtml(desc)}</span>` : ``}
      </div>
      <button aria-label="close">√ó</button>
    `;
    el.querySelector("button").onclick = () => el.remove();
    toastsEl.appendChild(el);
    setTimeout(() => el.remove(), 4200);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function applyTheme(theme){
    document.body.dataset.theme = theme;
    // primary color from settings
    const vars = theme === "light" ? state.ui.light : state.ui.dark;
    if (vars?.primary) document.documentElement.style.setProperty("--primary", vars.primary);
    if (theme === "light") document.documentElement.style.setProperty("--bg", vars?.bg || "#f5f7fb");
    if (theme === "dark") document.documentElement.style.setProperty("--bg", vars?.bg || "#070b12");
    // font
    if (state.ui.font) document.documentElement.style.setProperty("--font", state.ui.font + ", " + getComputedStyle(document.documentElement).getPropertyValue("--font"));
  }

  function closeDrawer(){
    drawer.classList.remove("open");
    drawerBackdrop.classList.remove("open");
  }
  function openDrawer(){
    drawerBackdrop.classList.add("open");
    drawer.style.display = "block";
    drawer.classList.add("open");
  }
  drawerBackdrop.onclick = closeDrawer;

  // ===== API helper =====
  async function apiFetch(path, opts={}){
    const options = {
      method: opts.method || "GET",
      credentials: "include",
      headers: opts.headers || {},
      body: opts.body,
    };

    // JSON by default if body is object
    if (opts.json !== false) {
      if (opts.body && typeof opts.body === "object" && !(opts.body instanceof FormData)) {
        options.headers["Content-Type"] = "application/json";
        options.body = JSON.stringify(opts.body);
      }
    }

    showLoading(opts.loadingTitle, opts.loadingText);

    try{
      const res = await fetch(API_BASE + path, options);

      let data = null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) data = await res.json();
      else data = { ok:false, error: await res.text() };

      // If session expired
      if (res.status === 401) {
        state.user = null;
        if (location.hash !== "#/login") location.hash = "#/login";
      }

      if (!res.ok || data?.ok === false) {
        const errMsg = data?.error || ("HTTP " + res.status);
        throw new Error(errMsg);
      }

      return data;
    } finally {
      hideLoading();
    }
  }

  // ===== Boot & routing =====
  const routes = [
    { key:"main",     hash:"#/main",     icon:"üè†", desc:"", requiresAuth:true },
    { key:"tasks",    hash:"#/tasks",    icon:"üß©", desc:"", requiresAuth:true },
    { key:"projects", hash:"#/projects", icon:"üìå", desc:"", requiresAuth:true },
    { key:"courses",  hash:"#/courses",  icon:"üéì", desc:"", requiresAuth:true },
    { key:"clients",  hash:"#/clients",  icon:"üóÇÔ∏è", desc:"", requiresAuth:true },
    { key:"settings", hash:"#/settings", icon:"‚öôÔ∏è", desc:"", requiresAuth:true },
    { key:"users",    hash:"#/users",    icon:"üë•", desc:"", requiresAuth:true, adminOnly:true },
    { key:"login",    hash:"#/login",    icon:"",   desc:"", requiresAuth:false },
  ];

  function buildNav(container){
    container.innerHTML = "";
    const current = location.hash || DEFAULT_ROUTE;

    for (const r of routes) {
      if (r.key === "login") continue;
      if (r.adminOnly && state.user?.role !== "admin") continue;

      const a = document.createElement("a");
      a.href = r.hash;
      a.className = current.startsWith(r.hash) ? "active" : "";
      a.innerHTML = `
        <div class="ico" aria-hidden="true">${r.icon}</div>
        <div class="meta">
          <b>${t(r.key)}</b>
          <span>${r.desc || ""}</span>
        </div>
      `;
      a.onclick = () => closeDrawer();
      container.appendChild(a);
    }
  }

  function renderAppShell(){
    root.innerHTML = `
      <div class="app">
        <aside class="sidebar">
          <div class="brand" style="padding: 2px 6px 10px 6px;">
            <div class="logo" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M7 14c2.5 2.5 7.5 2.5 10 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 10c3.8-5.2 12.2-5.2 16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 21c-1.7-3.7-1.7-8.3 0-12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="brand-title">
              <b>G-SOFT | Management</b>
              <span>ofis.gekto.uz</span>
            </div>
          </div>

          <nav id="nav" class="nav"></nav>

          <div class="card" style="margin-top:auto">
            <div class="hd">
              <b>${escapeHtml(state.user?.ism || "")}</b>
              <span>${escapeHtml(state.user?.role || "")}</span>
            </div>
            <div class="bd">
              <div class="row" style="justify-content:space-between">
                <button class="btn danger" id="btnLogout">‚éã ${t("logout")}</button>
                <button class="btn" id="btnLang">üåê ${state.ui.lang.toUpperCase()}</button>
              </div>
            </div>
          </div>
        </aside>

        <header class="topbar">
          <div class="brand">
            <button class="burger" id="burger" aria-label="menu"><span></span></button>
            <div class="brand-title">
              <b id="pageTitle">G-SOFT</b>
              <span id="pageSub">${t("welcome")}</span>
            </div>
          </div>

          <div class="top-actions">
            <div class="pill" title="Session cookie + idle TTL">
              <div class="dot"></div>
              <div class="text" id="userPill">${escapeHtml(state.user?.ism || "")} ‚Ä¢ ${escapeHtml(state.user?.role || "")}</div>
            </div>

            <button class="btn theme-toggle" id="themeToggle" title="Theme">
              <svg class="icon sun" viewBox="0 0 24 24" fill="none">
                <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <svg class="icon moon" viewBox="0 0 24 24" fill="none">
                <path d="M21 14.5A8 8 0 0 1 9.5 3a6.5 6.5 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </button>

            <button class="btn" id="btnQuickLogout" title="Logout">‚éã</button>
          </div>
        </header>

        <main class="main">
          <div class="content" id="view"></div>
        </main>
      </div>
    `;

    // nav
    buildNav($("#nav"));
    buildNav($("#navDrawer"));

    // burger
    $("#burger").onclick = () => openDrawer();

    // theme toggle
    $("#themeToggle").onclick = async () => {
      state.ui.theme = (state.ui.theme === "dark") ? "light" : "dark";
      applyTheme(state.ui.theme);
      toast("Theme", state.ui.theme === "dark" ? "Dark mode" : "Light mode");

      // save user ui settings
      try{
        await apiFetch("/ui/me", { method:"POST", body: state.ui, loadingTitle: "Sozlamalar", loadingText: "Saqlanmoqda..." });
      }catch(e){
        toast("UI save failed", e.message, "err");
      }
    };

    // lang cycle
    $("#btnLang").onclick = async () => {
      const order = ["ru","uz","en"];
      const i = order.indexOf(state.ui.lang);
      state.ui.lang = order[(i+1)%order.length];
      toast("Language", state.ui.lang.toUpperCase());
      // rerender shell (texts)
      render();
      try{
        await apiFetch("/ui/me", { method:"POST", body: state.ui, loadingTitle: "Sozlamalar", loadingText: "Saqlanmoqda..." });
      }catch(e){
        toast("UI save failed", e.message, "err");
      }
    };

    // logout
    const doLogout = async () => {
      try{
        await apiFetch("/auth/logout", { method:"POST", json:false, loadingTitle:"Chiqish", loadingText:"Session yopilmoqda..." });
      }catch(_){}
      state.user = null;
      location.hash = "#/login";
    };
    $("#btnLogout").onclick = doLogout;
    $("#btnQuickLogout").onclick = doLogout;
  }

  function renderLogin(){
    root.innerHTML = `
      <div class="auth">
        <div class="card auth-card">
          <div class="auth-inner">
            <div class="auth-top">
              <div class="logo" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M7 14c2.5 2.5 7.5 2.5 10 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M4 10c3.8-5.2 12.2-5.2 16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M12 21c-1.7-3.7-1.7-8.3 0-12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="brand-title">
                <b>G-SOFT | Management</b>
                <span>${t("loginTitle")}</span>
              </div>

              <div style="margin-left:auto; display:flex; gap:10px">
                <button class="btn theme-toggle" id="themeToggleLogin" title="Theme">
                  <svg class="icon sun" viewBox="0 0 24 24" fill="none">
                    <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <svg class="icon moon" viewBox="0 0 24 24" fill="none">
                    <path d="M21 14.5A8 8 0 0 1 9.5 3a6.5 6.5 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="btn" id="btnLangLogin">üåê ${state.ui.lang.toUpperCase()}</button>
              </div>
            </div>

            <div class="error" id="errBox"></div>

            <div class="grid" style="grid-template-columns:1fr; gap:12px">
              <div class="field">
                <div class="label">${t("login")}</div>
                <input id="login" autocomplete="username" placeholder="admin" />
              </div>
              <div class="field">
                <div class="label">${t("password")}</div>
                <input id="pass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
            </div>

            <div class="auth-actions">
              <button class="btn primary" id="btnSignIn">‚Üí ${t("signIn")}</button>
            </div>

            <div class="muted" style="font-size:12px; line-height:1.45">
              API: <b>${API_BASE}</b><br>
              Session-cookie + idle TTL: <b>3 min</b>
            </div>
          </div>
        </div>
      </div>
    `;

    $("#themeToggleLogin").onclick = () => {
      state.ui.theme = (state.ui.theme === "dark") ? "light" : "dark";
      applyTheme(state.ui.theme);
    };
    $("#btnLangLogin").onclick = () => {
      const order = ["ru","uz","en"];
      const i = order.indexOf(state.ui.lang);
      state.ui.lang = order[(i+1)%order.length];
      render();
    };

    const errBox = $("#errBox");
    const showErr = (msg) => {
      errBox.textContent = msg;
      errBox.classList.add("show");
    };
    const clearErr = () => errBox.classList.remove("show");

    const signIn = async () => {
      clearErr();
      const login = $("#login").value.trim();
      const password = $("#pass").value;
      if (!login || !password) return showErr("Login/parol kiriting.");

      try{
        const data = await apiFetch("/auth/login", {
          method:"POST",
          body: { login, password },
          loadingTitle: "Kirish",
          loadingText: "Tekshirilmoqda..."
        });

        // after login, refresh me
        const me = await apiFetch("/auth/me", { loadingTitle:"Kirish", loadingText:"Profil olinmoqda..." });
        state.user = me.user;

        // load UI and cache
        await loadUiSettings();
        applyTheme(state.ui.theme);

        toast("OK", "Logged in");
        if (!location.hash || location.hash === "#/login") location.hash = DEFAULT_ROUTE;
        render();
      }catch(e){
        showErr(e.message || "Login xato");
      }
    };

    $("#btnSignIn").onclick = signIn;
    $("#pass").addEventListener("keydown", (e) => { if (e.key==="Enter") signIn(); });
    $("#login").addEventListener("keydown", (e) => { if (e.key==="Enter") signIn(); });
  }

  function setPageTitle(key){
    const title = t(key);
    const el = $("#pageTitle");
    if (el) el.textContent = title;
  }

  function renderView(){
    const hash = location.hash || DEFAULT_ROUTE;
    const view = $("#view");

    // Route guard
    if (!state.user) {
      location.hash = "#/login";
      return;
    }

    // Active nav
    const nav = $("#nav");
    if (nav) buildNav(nav);
    buildNav($("#navDrawer"));

    // Determine route
    const key = (hash.split("/")[1] || "tasks").toLowerCase();

    // Default route if unknown
    const allowedKeys = new Set(["main","tasks","projects","courses","clients","settings","users"]);
    const rkey = allowedKeys.has(key) ? key : "tasks";

    // Admin guard
    if (rkey === "users" && state.user.role !== "admin") {
      location.hash = DEFAULT_ROUTE;
      return;
    }

    setPageTitle(rkey);

    // Views (placeholders now)
    if (rkey === "main") {
      view.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr; gap:16px">
          <div class="card">
            <div class="hd"><b>${t("main")}</b><span class="muted">Dashboard (keyingi bosqich)</span></div>
            <div class="bd">
              <div class="h1">${t("welcome")}, ${escapeHtml(state.user.ism)} üëã</div>
              <div class="muted">Bu yerda: muddatdan o'tgan vazifalar, bugungi ustuvor vazifalar, tezkor ko‚Äòrsatkichlar bo‚Äòladi.</div>
            </div>
          </div>
        </div>
      `;
      return;
    }

    if (rkey === "tasks") {
      view.innerHTML = `
        <div class="card">
          <div class="hd">
            <b>${t("tasks")}</b>
            <span class="muted">Kanban (–≠—Ç–∞–ø 9)</span>
          </div>
          <div class="bd">
            <div class="row">
              <div class="field" style="min-width:240px">
                <div class="label">Project</div>
                <div class="select-wrap">
                  <select>
                    <option>–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                  </select>
                </div>
              </div>
              <div class="field" style="min-width:240px">
                <div class="label">Deadline</div>
                <div class="select-wrap">
                  <select>
                    <option>–°–Ω–∞—á–∞–ª–∞ —Å—Ä–æ—á–Ω—ã–µ</option>
                    <option>–°–Ω–∞—á–∞–ª–∞ –¥–µ–¥–ª–∞–π–Ω</option>
                  </select>
                </div>
              </div>

              <button class="btn primary" style="margin-left:auto">Ôºã –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="muted" style="margin-top:14px">
              Keyingi bosqichda: drag&drop, —Ç–∞–π–º–µ—Ä, "1 Jarayonda", –º–æ–¥–∞–ª–∫–∞ –∑–∞–¥–∞—á–∏.
            </div>
          </div>
        </div>
      `;
      return;
    }

    if (rkey === "projects") {
      view.innerHTML = `
        <div class="card">
          <div class="hd"><b>${t("projects")}</b><span class="muted">Pipeline (–≠—Ç–∞–ø 10)</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn primary">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
              <span class="muted">Keyingi bosqichda: kanban pipeline + info modal + ‚ÄúO'tish‚Äù ‚Üí Vazifalar.</span>
            </div>
          </div>
        </div>
      `;
      return;
    }

    if (rkey === "courses") {
      view.innerHTML = `
        <div class="card">
          <div class="hd"><b>${t("courses")}</b><span class="muted">Leads + enrollments (–≠—Ç–∞–ø 11)</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn primary">Ôºã Lead qo‚Äòshish</button>
              <span class="muted">Kurslar bo‚Äòyicha alohida lead bazasi.</span>
            </div>
          </div>
        </div>
      `;
      return;
    }

    if (rkey === "clients") {
      view.innerHTML = `
        <div class="card">
          <div class="hd"><b>${t("clients")}</b><span class="muted">Clients + deals (–≠—Ç–∞–ø 12)</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn primary">Ôºã –ö–ª–∏–µ–Ω—Ç qo‚Äòshish</button>
              <span class="muted">–ö–æ–º–ø–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –§–ò–û –æ—Ç–¥–µ–ª—å–Ω–æ, —Å–¥–µ–ª–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ.</span>
            </div>
          </div>
        </div>
      `;
      return;
    }

    if (rkey === "settings") {
      view.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr; gap:16px">
          <div class="card">
            <div class="hd"><b>${t("settings")}</b><span class="muted">Spravochniklar + UI</span></div>
            <div class="bd">
              <div class="row">
                <button class="btn" id="btnLoadDict">‚ü≤ Reload dict</button>
                <span class="muted">cities / sources / services</span>
              </div>

              <div class="grid" style="grid-template-columns: repeat(3, minmax(220px, 1fr)); gap: 14px; margin-top: 14px">
                ${renderDictCard("cities","Cities")}
                ${renderDictCard("sources","Sources")}
                ${renderDictCard("services","Services")}
              </div>
            </div>
          </div>
        </div>
      `;

      $("#btnLoadDict").onclick = async () => {
        await preloadCache(true);
        render(); // rerender settings to show counts
        toast("OK","Dictionary reloaded");
      };

      return;
    }

    if (rkey === "users") {
      view.innerHTML = `
        <div class="card">
          <div class="hd">
            <b>${t("users")}</b>
            <span class="muted">Admin only</span>
          </div>
          <div class="bd">
            <div class="row">
              <button class="btn primary" id="btnUsersReload">‚ü≤ Reload</button>
              <button class="btn" id="btnUserAdd">Ôºã Add user</button>
              <span class="muted">CRUD —É–∂–µ –≥–æ—Ç–æ–≤ –Ω–∞ backend. UI —Å–¥–µ–ª–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.</span>
            </div>
            <div class="muted" style="margin-top:14px">
              Keyingi bosqich: users list + edit modal + reset password + time stats.
            </div>
          </div>
        </div>
      `;

      $("#btnUsersReload").onclick = async () => {
        try{
          const data = await apiFetch("/users", { loadingTitle:"Users", loadingText:"Yuklanmoqda..." });
          toast("Users loaded", "Count: " + (data.users?.length||0));
        }catch(e){
          toast("Error", e.message, "err");
        }
      };

      $("#btnUserAdd").onclick = () => toast("Next step", "UI modal for adding user", "ok");
      return;
    }
  }

  function renderDictCard(key, title){
    const count = state.dict[key]?.length || 0;
    return `
      <div class="card">
        <div class="hd"><b>${title}</b><span class="muted">${count} items</span></div>
        <div class="bd">
          <div class="muted" style="font-size:12px; margin-bottom:10px">
            API: <b>/dict/${key}</b>
          </div>
          <div class="row">
            <button class="btn" onclick="window.__gs_openDict('${key}')">Open</button>
            <button class="btn primary" onclick="window.__gs_addDict('${key}')">Ôºã Add</button>
          </div>
        </div>
      </div>
    `;
  }

  // expose quick actions for dict cards
  window.__gs_openDict = async (key) => {
    try{
      const data = await apiFetch("/dict/" + key, { loadingTitle:"Dict", loadingText:"Loading..." });
      toast(key, "Loaded: " + (data.items?.length||0));
    }catch(e){
      toast("Error", e.message, "err");
    }
  };
  window.__gs_addDict = async (key) => {
    const name = prompt("New item name:");
    if (!name) return;
    try{
      await apiFetch("/dict/" + key, { method:"POST", body:{ name, active:true }, loadingTitle:"Dict", loadingText:"Saving..." });
      await preloadCache(true);
      toast("Saved", name);
      render();
    }catch(e){
      toast("Error", e.message, "err");
    }
  };

  async function loadUiSettings(){
    // merge global + user (user overrides)
    let global = null, user = null;
    try{
      if (state.user?.role === "admin") {
        const g = await apiFetch("/ui/global", { loadingTitle:"UI", loadingText:"Global settings..." });
        global = g.settings;
      }
    }catch(_){}

    try{
      const u = await apiFetch("/ui/me", { loadingTitle:"UI", loadingText:"User settings..." });
      user = u.settings;
    }catch(_){}

    const base = Object.assign({}, state.ui, global || {});
    state.ui = Object.assign(base, user || {});
  }

  async function preloadCache(force=false){
    if (state.cacheReady && !force) return;
    const tasks = [
      apiFetch("/dict/cities",   { loadingTitle:"Cache", loadingText:"cities..." }).catch(() => ({items:[]})),
      apiFetch("/dict/sources",  { loadingTitle:"Cache", loadingText:"sources..." }).catch(() => ({items:[]})),
      apiFetch("/dict/services", { loadingTitle:"Cache", loadingText:"services..." }).catch(() => ({items:[]})),
    ];
    const [cities, sources, services] = await Promise.all(tasks);
    state.dict.cities = cities.items || [];
    state.dict.sources = sources.items || [];
    state.dict.services = services.items || [];
    state.cacheReady = true;
  }

  async function boot(){
    // try restore auth
    try{
      const me = await apiFetch("/auth/me", { loadingTitle:"Auth", loadingText:"Checking session..." });
      state.user = me.user;
      await loadUiSettings();
      applyTheme(state.ui.theme);
      await preloadCache(false);

      // if on login -> go to tasks
      if (!location.hash || location.hash === "#/login") location.hash = DEFAULT_ROUTE;
      render();
    }catch(_){
      // not logged in
      applyTheme(state.ui.theme);
      if (!location.hash) location.hash = "#/login";
      render();
    }
  }

  function render(){
    const hash = location.hash || DEFAULT_ROUTE;

    if (hash === "#/login" || !state.user) {
      renderLogin();
      return;
    }

    renderAppShell();
    renderView();

    // close drawer on route changes on mobile
    closeDrawer();
  }

  window.addEventListener("hashchange", () => render());
  window.addEventListener("resize", () => {
    if (window.innerWidth > 980) closeDrawer();
  });

  // Init drawer visibility (avoid flash)
  drawer.style.display = "none";

  // Start
  boot();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>G-SOFT | Management</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg0:#071817;
      --bg1:#061312;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --brand:#FFD15C;
      --brand2:rgba(255,209,92,.14);
      --danger:#F16262;
      --ok:#46D3A2;
      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --r:20px;
      --r2:16px;
      --gap:14px;
      --t: 180ms cubic-bezier(.2,.8,.2,1);
      --scrollTrack: rgba(255,255,255,.06);
      --scrollThumb: rgba(255,255,255,.18);
      --scrollThumbHover: rgba(255,255,255,.28);
    }
    [data-theme="light"]{
      --bg0:#F4F7FB;
      --bg1:#EAF1FA;
      --card:rgba(9,20,30,.06);
      --card2:rgba(9,20,30,.08);
      --line:rgba(9,20,30,.12);
      --text:rgba(9,20,30,.92);
      --muted:rgba(9,20,30,.62);
      --brand:#0EA5E9;
      --brand2:rgba(14,165,233,.14);
      --shadow: 0 18px 70px rgba(10,25,40,.14);
      --scrollTrack: rgba(9,20,30,.06);
      --scrollThumb: rgba(9,20,30,.18);
      --scrollThumbHover: rgba(9,20,30,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 12%, rgba(255,209,92,.16), transparent 55%),
        radial-gradient(900px 520px at 90% 30%, rgba(14,165,233,.14), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* Brand scroll */
    *::-webkit-scrollbar{height:12px;width:12px}
    *::-webkit-scrollbar-track{background:var(--scrollTrack);border-radius:999px}
    *::-webkit-scrollbar-thumb{background:var(--scrollThumb);border-radius:999px}
    *::-webkit-scrollbar-thumb:hover{background:var(--scrollThumbHover)}
    *{scrollbar-color: var(--scrollThumb) var(--scrollTrack); scrollbar-width: thin;}

    a{color:inherit}
    .hidden{display:none !important}

    /* ===== Overlay loading (blocks everything) ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:center;
      z-index:5000;
    }
    [data-theme="light"] .overlay{background:rgba(255,255,255,.35)}
    .overlayCard{
      width:min(420px,92vw);
      border-radius:24px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.07);
      box-shadow:var(--shadow);
      padding:18px 18px 14px;
      display:flex; gap:14px; align-items:center;
    }
    [data-theme="light"] .overlayCard{background:rgba(255,255,255,.72)}
    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:3px solid rgba(255,255,255,.18);
      border-top-color: var(--brand);
      animation: spin .9s linear infinite;
      flex:0 0 auto;
    }
    [data-theme="light"] .spinner{border-color: rgba(9,20,30,.12)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlayTxt b{display:block; font-weight:1000}
    .overlayTxt small{color:var(--muted)}

    /* ===== Toasts ===== */
    .toasts{
      position:fixed; right:14px; bottom:14px;
      display:flex; flex-direction:column; gap:10px;
      z-index:6000;
      max-width:min(420px,92vw);
    }
    .toast{
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      backdrop-filter: blur(14px);
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:flex; gap:10px; align-items:flex-start;
      animation: pop .16s ease-out;
    }
    [data-theme="light"] .toast{background:rgba(255,255,255,.82)}
    .toastDot{width:10px;height:10px;border-radius:999px;background:var(--brand);margin-top:6px}
    .toast b{display:block;font-weight:1000}
    .toast small{color:var(--muted)}
    @keyframes pop{from{transform:translateY(8px);opacity:.4}to{transform:none;opacity:1}}

    /* ===== Auth view ===== */
    .authWrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .authCard{
      width:min(480px, 94vw);
      border-radius:28px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.07);
      box-shadow:var(--shadow);
      padding:18px;
    }
    [data-theme="light"] .authCard{background:rgba(255,255,255,.78)}
    .authTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:10px;
    }
    .brandTitle{font-weight:1100; font-size:18px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-top:12px;
    }
    .label{font-size:11px; color:var(--muted); font-weight:900; text-transform:uppercase; letter-spacing:.2px}
    .input{
      height:44px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    .input:focus{border-color:rgba(255,255,255,.22); box-shadow:0 0 0 4px rgba(255,209,92,.14)}
    [data-theme="light"] .input:focus{box-shadow:0 0 0 4px rgba(14,165,233,.14)}
    .authActions{display:flex; gap:10px; margin-top:14px; align-items:center; justify-content:space-between; flex-wrap:wrap}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      transition: transform var(--t), background var(--t);
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      background:rgba(255,209,92,.92);
      border-color:rgba(255,209,92,.25);
      color:#061a14;
    }
    [data-theme="light"] .btn.primary{
      background:rgba(14,165,233,.92);
      border-color:rgba(14,165,233,.25);
      color:#061a14;
    }
    .btn.danger{background:rgba(241,98,98,.14); border-color:rgba(241,98,98,.22)}
    .btn.icon{width:44px;height:44px;padding:0}

    /* ===== App shell ===== */
    .shell{
      height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "side top"
        "side main";
    }
    header.top{
      grid-area: top;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(14px);
    }
    aside.side{
      grid-area: side;
      border-right:1px solid var(--line);
      background:rgba(255,255,255,.03);
      backdrop-filter: blur(14px);
      padding:12px;
      overflow:auto;
    }
    main.main{
      grid-area: main;
      padding:14px;
      min-height:0;
      overflow:hidden;
    }

    .topLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .burger{
      display:none;
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .burger svg{width:20px;height:20px}
    .topBrand{min-width:0}
    .topBrand b{display:block; font-weight:1100; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .topBrand small{display:block; color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .topRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    /* theme toggle icon animation */
    .themeBtn{position:relative; overflow:hidden}
    .themeBtn .sun{opacity:0; transform:translateY(10px) rotate(25deg) scale(.8); transition:all .45s var(--t)}
    .themeBtn .moon{opacity:1; transform:none; transition:all .45s var(--t)}
    [data-theme="light"] .themeBtn .sun{opacity:1; transform:none}
    [data-theme="light"] .themeBtn .moon{opacity:0; transform:translateY(-10px) rotate(-25deg) scale(.8)}

    .navGroup{display:flex; flex-direction:column; gap:10px}
    .navItem{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid transparent;
      cursor:pointer;
      background:transparent;
      user-select:none;
    }
    .navItem:hover{background:rgba(255,255,255,.06); border-color:var(--line)}
    .navItem.active{background:var(--brand2); border-color:rgba(255,255,255,.12)}
    [data-theme="light"] .navItem.active{border-color:rgba(9,20,30,.12)}
    .navItem b{font-weight:1000}
    .navItem small{color:var(--muted); font-size:12px}
    .navDot{width:8px;height:8px;border-radius:999px;background:var(--brand); opacity:.8}

    /* ===== Page card ===== */
    .pageCard{
      height:100%;
      min-height:0;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }
    .pageTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .pageTop h1{margin:0; font-size:18px; font-weight:1100}
    .pageTop p{margin:4px 0 0; color:var(--muted); font-size:12px}

    /* ===== Custom select ===== */
    .bsel{position:relative; display:flex; flex-direction:column; gap:6px; min-width:200px}
    .bsel.compact{min-width:170px}
    .bselBtn{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      height:44px; padding:0 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .bselBtn:hover{background:rgba(255,255,255,.09)}
    .bselVal{font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bselMenu{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(20,30,35,.92);
      box-shadow:var(--shadow);
      padding:6px;
      display:none;
      max-height:320px;
      overflow:auto;
      z-index:1500;
      backdrop-filter: blur(16px);
    }
    [data-theme="light"] .bselMenu{background:rgba(255,255,255,.92)}
    .bsel.open .bselMenu{display:block; animation: pop .14s ease-out}
    .bselItem{
      padding:10px 10px;
      border-radius:14px;
      cursor:pointer;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      border:1px solid transparent;
    }
    .bselItem:hover{background:rgba(255,255,255,.06); border-color:var(--line)}
    .bselItem.active{background:var(--brand2); border-color:rgba(255,255,255,.12)}

    .toolbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .toolbarLeft{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .toolbarRight{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}

    /* ===== Kanban full screen ===== */
    .kanbanWrap{
      flex:1;
      min-height:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .kanban{
      height:100%;
      display:flex;
      gap:12px;
      padding:12px;
      overflow:auto; /* horizontal scroll here */
    }
    .col{
      flex:0 0 320px;
      min-width:320px;
      max-width:420px;
      height:100%;
      display:flex;
      flex-direction:column;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      overflow:hidden;
      transition: border-color var(--t), transform var(--t);
    }
    .col.dragOver{border-color:rgba(255,209,92,.42); transform:translateY(-2px)}
    [data-theme="light"] .col.dragOver{border-color:rgba(14,165,233,.42)}
    .colHdr{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .colHdr b{font-weight:1100}
    .colHdr small{color:var(--muted); font-size:12px}
    .colBody{
      flex:1;
      min-height:0;
      overflow:auto; /* vertical scroll inside column */
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .task{
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--card2);
      padding:10px 10px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform var(--t), border-color var(--t), background var(--t);
      position:relative;
    }
    .task:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.22)}
    .taskTitle{font-weight:1100; line-height:1.15}
    .taskMeta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:1000;
      color:var(--text);
      font-size:12px;
    }
    .chip.ok{border-color:rgba(70,211,162,.35); background:rgba(70,211,162,.12)}
    .chip.bad{border-color:rgba(241,98,98,.35); background:rgba(241,98,98,.12)}
    .chip.run{border-color:rgba(255,209,92,.35); background:rgba(255,209,92,.12)}
    [data-theme="light"] .chip.run{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.12)}

    .ghost{
      position:fixed;
      pointer-events:none;
      z-index:7000;
      width:320px;
      transform:translate(-50%,-50%) rotate(-.7deg);
      opacity:.95;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
    }
    .dragging .task{opacity:.35}
    .dragging body{cursor:grabbing}

    /* ===== Modal ===== */
    .modalBack{
      position:fixed; inset:0;
      z-index:8000;
      background:rgba(0,0,0,.42);
      backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    [data-theme="light"] .modalBack{background:rgba(255,255,255,.42)}
    .modal{
      width:min(720px, 96vw);
      max-height:min(88vh, 900px);
      overflow:auto;
      border-radius:28px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      padding:14px;
    }
    [data-theme="light"] .modal{background:rgba(255,255,255,.86)}
    .modalHdr{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .modalHdr h2{margin:0; font-size:18px; font-weight:1100}
    .modalHdr small{color:var(--muted)}
    .modalGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .modalGrid .field{margin-top:0}
    .modalActions{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:14px;
      justify-content:flex-end;
    }
    .textarea{min-height:110px; padding:10px 12px; resize:vertical}
    .rowInfo{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
    }

    /* ===== Mobile ===== */
    @media (max-width: 980px){
      .shell{
        grid-template-columns: 1fr;
        grid-template-areas:
          "top"
          "main";
      }
      aside.side{
        position:fixed;
        top:64px; left:12px;
        width:min(320px, 88vw);
        height: calc(100% - 76px);
        z-index:9000;
        border-radius:22px;
        box-shadow:var(--shadow);
        transform: translateX(-120%);
        transition: transform .22s var(--t);
      }
      aside.side.open{transform: translateX(0)}
      .burger{display:inline-flex; align-items:center; justify-content:center}
      main.main{padding:12px}
      .col{flex-basis: 300px; min-width:300px}
      .modalGrid{grid-template-columns:1fr}
    }

    /* Small helpers */
    .kbd{font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; opacity:.8}
  </style>
</head>

<body data-theme="dark">
  <div id="auth" class="authWrap">
    <div class="authCard">
      <div class="authTop">
        <div>
          <div class="brandTitle">G-SOFT | Management</div>
          <div class="brandSub">ofis.gekto.uz</div>
        </div>
        <button id="authTheme" class="btn icon themeBtn" title="Theme">
          <svg class="sun" viewBox="0 0 24 24" fill="none"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.4 1.4M17.6 17.6 19 19M19 5l-1.4 1.4M6.4 17.6 5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <svg class="moon" viewBox="0 0 24 24" fill="none"><path d="M21 14.5A8.5 8.5 0 0 1 9.5 3a6.5 6.5 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="field">
        <div class="label">Login</div>
        <input id="login" class="input" autocomplete="username" placeholder="admin" />
      </div>
      <div class="field">
        <div class="label">Parol</div>
        <input id="password" class="input" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>

      <div class="authActions">
        <button id="loginBtn" class="btn primary" style="min-width:180px">Kirish</button>
        <small class="brandSub">Session-cookie ¬∑ idle TTL 3 min</small>
      </div>
    </div>
  </div>

  <div id="shell" class="shell hidden">
    <header class="top">
      <div class="topLeft">
        <button id="burger" class="burger btn icon" title="Menu">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="topBrand">
          <b>G-SOFT | Management</b>
          <small id="who">‚Äî</small>
        </div>
      </div>
      <div class="topRight">
        <button id="themeBtn" class="btn icon themeBtn" title="Theme">
          <svg class="sun" viewBox="0 0 24 24" fill="none"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.4 1.4M17.6 17.6 19 19M19 5l-1.4 1.4M6.4 17.6 5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <svg class="moon" viewBox="0 0 24 24" fill="none"><path d="M21 14.5A8.5 8.5 0 0 1 9.5 3a6.5 6.5 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="logoutBtn" class="btn danger">Chiqish</button>
      </div>
    </header>

    <aside id="side" class="side">
      <div class="navGroup" id="nav"></div>
      <div style="margin-top:14px; color:var(--muted); font-size:12px">
        <div><b class="kbd">Tip:</b> drag & drop ‚Äî faqat ‚Äúqo‚Äòyib yuborganda‚Äù bajariladi.</div>
      </div>
    </aside>

    <main class="main">
      <div id="page" class="pageCard"></div>
    </main>
  </div>

  <div id="overlay" class="overlay hidden">
    <div class="overlayCard">
      <div class="spinner"></div>
      <div class="overlayTxt">
        <b>Yuklanyapti‚Ä¶</b>
        <small>Iltimos, kuting</small>
      </div>
    </div>
  </div>

  <div id="toasts" class="toasts"></div>
  <div id="modalHost"></div>

<script>
(() => {
  // ====== CONFIG ======
  const API = "https://api.ofis.gekto.uz"; // <- –µ—Å–ª–∏ –Ω–∞–¥–æ –ø–æ–º–µ–Ω—è—Ç—å

  // ====== STATE ======
  const S = {
    me: null,
    tasks: [],
    filter: { project: "all", user: "all", status: "all" },
    ui: { loading: 0, theme: localStorage.getItem("gsoft_theme") || "dark", sideOpen:false },
    drag: null
  };

  // ====== DOM ======
  const $ = (q, el=document) => el.querySelector(q);
  const auth = $("#auth");
  const shell = $("#shell");
  const page = $("#page");
  const nav = $("#nav");
  const overlay = $("#overlay");
  const toasts = $("#toasts");
  const modalHost = $("#modalHost");
  const side = $("#side");
  const who = $("#who");

  // ====== UI helpers ======
  function setTheme(theme){
    S.ui.theme = theme;
    document.body.setAttribute("data-theme", theme);
    localStorage.setItem("gsoft_theme", theme);
  }
  setTheme(S.ui.theme);

  function toast(title, msg, color="brand"){
    const el = document.createElement("div");
    el.className = "toast";
    const dot = document.createElement("div");
    dot.className = "toastDot";
    dot.style.background = (color==="danger") ? "var(--danger)" : (color==="ok" ? "var(--ok)" : "var(--brand)");
    el.appendChild(dot);
    const box = document.createElement("div");
    box.innerHTML = `<b>${escapeHtml(title)}</b><small>${escapeHtml(msg||"")}</small>`;
    el.appendChild(box);
    toasts.appendChild(el);
    setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(10px)"; }, 2600);
    setTimeout(() => el.remove(), 3200);
  }

  function loading(on){
    S.ui.loading += on ? 1 : -1;
    if (S.ui.loading < 0) S.ui.loading = 0;
    overlay.classList.toggle("hidden", S.ui.loading === 0);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDeadline(ts){
    if (!ts) return "‚Äî";
    const d = new Date(ts * 1000);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }

  // ====== API ======
  async function api(path, {method="GET", body=null} = {}){
    const opts = {
      method,
      headers: { "Content-Type":"application/json" },
      credentials: "include"
    };
    if (body) opts.body = JSON.stringify(body);
    loading(true);
    try{
      const res = await fetch(API + path, opts);
      if (res.status === 401){
        // session expired
        S.me = null;
        S.tasks = [];
        showAuth();
        toast("Session", "Qayta login qiling", "danger");
        throw new Error("Unauthorized");
      }
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch{ data = { ok:false, error:text }; }
      if (!res.ok || data?.ok === false){
        throw new Error(data?.error || ("HTTP " + res.status));
      }
      return data;
    } finally {
      loading(false);
    }
  }

  // ====== AUTH ======
  function showAuth(){
    auth.classList.remove("hidden");
    shell.classList.add("hidden");
    closeSide();
    modalHost.innerHTML = "";
    window.location.hash = "#/tasks";
  }
  function showApp(){
    auth.classList.add("hidden");
    shell.classList.remove("hidden");
  }

  async function checkMe(){
    try{
      const r = await api("/auth/me");
      S.me = r.user;
      who.textContent = `${S.me.ism} ¬∑ ${S.me.role}`;
      showApp();
      buildNav();
      await loadTasks();
      route();
      return true;
    }catch{
      return false;
    }
  }

  async function loginDo(){
    const login = $("#login").value.trim();
    const password = $("#password").value;
    if (!login || !password){
      toast("Xatolik", "Login va parolni kiriting", "danger");
      return;
    }
    await api("/auth/login", { method:"POST", body:{ login, password } });
    await checkMe();
    // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:
    window.location.hash = "#/tasks";
  }

  async function logoutDo(){
    try{ await api("/auth/logout", { method:"POST" }); }catch{}
    showAuth();
  }

  // ====== NAV + ROUTER ======
  const PAGES = [
    { id:"main", title:"Main", sub:"Bugungi ustuvorlar", icon:"‚Ä¢", hash:"#/main" },
    { id:"tasks", title:"Vazifalar", sub:"Kanban + timer", icon:"‚Ä¢", hash:"#/tasks" },
    { id:"projects", title:"Loyihalar", sub:"(keyin)", icon:"‚Ä¢", hash:"#/projects" },
    { id:"clients", title:"Baza", sub:"(keyin)", icon:"‚Ä¢", hash:"#/clients" },
    { id:"courses", title:"Kurslar", sub:"(keyin)", icon:"‚Ä¢", hash:"#/courses" },
    { id:"settings", title:"Sozlamalar", sub:"(keyin)", icon:"‚Ä¢", hash:"#/settings" },
    { id:"users", title:"Foydalanuvchilar", sub:"(keyin)", icon:"‚Ä¢", hash:"#/users" },
  ];

  function buildNav(){
    nav.innerHTML = "";
    const role = S.me?.role || "fin";
    // –ø–æ–∫–∞ –±–µ–∑ —Ä–æ–ª–µ–π/visibility ‚Äî –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞
    const canSee = (id) => {
      if (role === "admin") return true;
      if (role === "pm") return ["main","tasks","projects"].includes(id);
      return ["main","tasks","projects"].includes(id);
    };

    for (const p of PAGES){
      if (!canSee(p.id)) continue;
      const item = document.createElement("div");
      item.className = "navItem";
      item.dataset.id = p.id;
      item.innerHTML = `
        <div>
          <b>${p.title}</b><br/>
          <small>${p.sub}</small>
        </div>
        <div class="navDot"></div>
      `;
      item.addEventListener("click", () => {
        window.location.hash = p.hash;
        closeSide();
      });
      nav.appendChild(item);
    }
    syncNavActive();
  }

  function syncNavActive(){
    const id = (location.hash.replace("#/","") || "tasks").split("?")[0];
    [...nav.querySelectorAll(".navItem")].forEach(x => x.classList.toggle("active", x.dataset.id === id));
  }

  function route(){
    syncNavActive();
    const id = (location.hash.replace("#/","") || "tasks").split("?")[0];
    if (id === "main") return renderMain();
    if (id === "tasks") return renderTasks();
    return renderStub(id);
  }
  window.addEventListener("hashchange", route);

  // ====== SIDE (mobile) ======
  function openSide(){ S.ui.sideOpen = true; side.classList.add("open"); }
  function closeSide(){ S.ui.sideOpen = false; side.classList.remove("open"); }
  $("#burger").addEventListener("click", () => S.ui.sideOpen ? closeSide() : openSide());

  // click outside side on mobile
  document.addEventListener("click", (e) => {
    if (window.matchMedia("(max-width: 980px)").matches){
      if (S.ui.sideOpen && !side.contains(e.target) && !$("#burger").contains(e.target)){
        closeSide();
      }
    }
  });

  // ====== THEME BUTTONS ======
  function toggleTheme(){ setTheme(S.ui.theme === "dark" ? "light" : "dark"); }
  $("#themeBtn").addEventListener("click", toggleTheme);
  $("#authTheme").addEventListener("click", toggleTheme);

  // ====== LOAD DATA ======
  async function loadTasks(){
    const r = await api("/tasks");
    S.tasks = (r.tasks || []).map(t => ({
      ...t,
      deadline: t.deadline ? Number(t.deadline) : null,
      spent_min: Number(t.spent_min || 0),
      last_change_at: Number(t.last_change_at || 0),
    }));
  }

  // ====== PAGES ======
  function renderStub(id){
    page.innerHTML = `
      <div class="pageTop">
        <div>
          <h1>${escapeHtml(id)}</h1>
          <p>Keyingi bosqichda qo‚Äòshamiz.</p>
        </div>
      </div>
      <div style="color:var(--muted);font-size:13px">
        Hozir biz Vazifalar modulini 100% ideal qilamiz: drag&drop, modal, timer, mobil, tema.
      </div>
    `;
  }

  function renderMain(){
    const now = Math.floor(Date.now()/1000);
    const items = [...S.tasks]
      .filter(t => !["bajarildi","otmena"].includes(t.status))
      .sort((a,b) => (a.deadline||9e15) - (b.deadline||9e15))
      .slice(0, 12);

    const rows = items.map(t => {
      const overdue = t.deadline && t.deadline < now;
      return `
        <div class="task" data-id="${t.id}">
          <div class="taskTitle">${escapeHtml(t.title || "Vazifa")}</div>
          <div class="taskMeta">
            <span class="chip ${overdue ? "bad":"ok"}">üìÖ ${fmtDeadline(t.deadline)}</span>
            <span class="chip">‚è± ${Math.floor(t.spent_min/60)}h ${t.spent_min%60}m</span>
            <span class="chip">${escapeHtml(t.status)}</span>
          </div>
        </div>
      `;
    }).join("");

    page.innerHTML = `
      <div class="pageTop">
        <div>
          <h1>Main</h1>
          <p>Deadline bo‚Äòyicha ustuvor vazifalar</p>
        </div>
        <div class="toolbarRight">
          <button class="btn primary" id="refreshMain">Yangilash</button>
        </div>
      </div>
      <div style="flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:10px">
        ${rows || `<div style="color:var(--muted)">Hozircha vazifa yo‚Äòq.</div>`}
      </div>
    `;
    $("#refreshMain").addEventListener("click", async () => { await loadTasks(); renderMain(); });
    page.querySelectorAll(".task").forEach(el => el.addEventListener("click", () => openTaskModal(+el.dataset.id)));
  }

  // ====== Tasks Kanban ======
  const COLS = [
    { id:"boshlanmagan", title:"Boshlanmagan", hint:"0 vaqt sarflangan" },
    { id:"pauza",       title:"Pauza",       hint:"to‚Äòxtatilgan" },
    { id:"jarayonda",   title:"Jarayonda",   hint:"faqat 1 dona" },
    { id:"bajarildi",   title:"Bajarildi",   hint:"pm/admin qaytara oladi" },
    { id:"otmena",      title:"Otmena",      hint:"sabab bilan" },
  ];

  function renderTasks(){
    page.innerHTML = `
      <div class="pageTop">
        <div>
          <h1>Vazifalar</h1>
          <p>Kanban ¬∑ Drag & Drop ¬∑ Timer</p>
        </div>
        <div class="toolbarRight">
          <button class="btn primary" id="addTaskBtn">+ Vazifa</button>
          <button class="btn" id="refreshTasks">Yangilash</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbarLeft" id="filters"></div>
        <div class="toolbarRight"></div>
      </div>

      <div class="kanbanWrap">
        <div class="kanban" id="kanban"></div>
      </div>
    `;

    $("#refreshTasks").addEventListener("click", async () => { await loadTasks(); renderTasks(); });
    $("#addTaskBtn").addEventListener("click", () => openTaskCreateModal());

    renderFilters();
    renderKanban();
  }

  function renderFilters(){
    const box = $("#filters");
    box.innerHTML = "";
    // –ø–æ–∫–∞ –±–µ–∑ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á—Ç–æ–±—ã MVP –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª)
    box.appendChild(makeSelect({
      label:"Status",
      value:S.filter.status,
      options:[
        {value:"all", label:"Hammasi"},
        ...COLS.map(c => ({value:c.id, label:c.title}))
      ],
      onChange:(v)=>{ S.filter.status=v; renderKanban(); }
    }));
  }

  function filteredTasks(){
    let list = [...S.tasks];
    // status filter
    if (S.filter.status !== "all"){
      list = list.filter(t => t.status === S.filter.status);
    }
    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –¥–µ–¥–ª–∞–π–Ω / –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    list.sort((a,b) => (a.deadline||9e15) - (b.deadline||9e15) || (b.updated_at||0)-(a.updated_at||0));
    return list;
  }

  function renderKanban(){
    const root = $("#kanban");
    const now = Math.floor(Date.now()/1000);

    const list = filteredTasks();
    const by = {};
    for (const c of COLS) by[c.id] = [];
    for (const t of list){
      if (!by[t.status]) by[t.status] = [];
      by[t.status].push(t);
    }

    root.innerHTML = COLS.map(c => {
      const items = (by[c.id] || []).map(t => renderTaskCard(t, now)).join("");
      const count = (by[c.id] || []).length;
      return `
        <div class="col" data-status="${c.id}">
          <div class="colHdr">
            <div>
              <b>${c.title}</b><br/>
              <small>${c.hint}</small>
            </div>
            <div class="chip">${count}</div>
          </div>
          <div class="colBody">
            ${items || `<div style="color:var(--muted);font-size:13px;padding:6px">Bo‚Äòsh</div>`}
          </div>
        </div>
      `;
    }).join("");

    // bind task clicks + drag
    root.querySelectorAll(".task").forEach(el => {
      el.addEventListener("click", (e) => {
        if (S.drag) return;
        openTaskModal(+el.dataset.id);
      });
      bindDrag(el);
    });
  }

  function renderTaskCard(t, now){
    const overdue = t.deadline && t.deadline < now && !["bajarildi","otmena"].includes(t.status);
    const run = t.status === "jarayonda";
    const runMin = run ? Math.max(0, Math.floor((now - (t.last_change_at || now)) / 60)) : 0;
    const shownSpent = t.spent_min + runMin;
    const spentTxt = `${Math.floor(shownSpent/60)}h ${shownSpent%60}m`;

    let extra = "";
    if (t.status === "otmena" && t.cancel_reason){
      extra = `<span class="chip bad">üßæ ${escapeHtml(t.cancel_reason)}</span>`;
    }

    return `
      <div class="task" data-id="${t.id}">
        <div class="taskTitle">${escapeHtml(t.title || "Vazifa")}</div>
        <div class="taskMeta">
          <span class="chip ${overdue ? "bad":"ok"}">üìÖ ${fmtDeadline(t.deadline)}</span>
          <span class="chip ${run ? "run":""}">‚è± ${escapeHtml(spentTxt)}</span>
          ${run ? `<span class="chip run">‚ñ∂ live</span>` : ""}
          ${extra}
        </div>
      </div>
    `;
  }

  // ===== Drag & drop (pointer, executes on release) =====
  function bindDrag(card){
    card.addEventListener("pointerdown", (e) => {
      // left click / touch only
      if (e.button !== 0 && e.pointerType === "mouse") return;
      // do not start drag if user is selecting text
      e.preventDefault();

      const id = +card.dataset.id;
      const task = S.tasks.find(x => x.id === id);
      if (!task) return;

      const rect = card.getBoundingClientRect();
      const ghost = card.cloneNode(true);
      ghost.classList.add("ghost");
      ghost.style.width = rect.width + "px";

      document.body.appendChild(ghost);
      document.body.classList.add("dragging");

      S.drag = {
        id, task,
        ghost,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top,
        lastOver: null
      };

      moveGhost(e.clientX, e.clientY);
      card.setPointerCapture(e.pointerId);

      card.addEventListener("pointermove", onMove);
      card.addEventListener("pointerup", onUp, { once:true });
      card.addEventListener("pointercancel", onUp, { once:true });

      function onMove(ev){
        if (!S.drag) return;
        moveGhost(ev.clientX, ev.clientY);
        const col = findColUnder(ev.clientX, ev.clientY);
        setDragOver(col);
      }

      async function onUp(ev){
        card.removeEventListener("pointermove", onMove);
        finishDrag();
        const col = findColUnder(ev.clientX, ev.clientY);
        clearDragOver();

        if (!col) return;

        const toStatus = col.dataset.status;
        const fromStatus = task.status;
        if (toStatus === fromStatus) return;

        // allowed transitions
        const ok =
          (["boshlanmagan","pauza","jarayonda"].includes(fromStatus) && ["boshlanmagan","pauza","jarayonda","bajarildi","otmena"].includes(toStatus)) ||
          (["bajarildi","otmena"].includes(fromStatus) && toStatus === "pauza");

        if (!ok) return;

        try{
          // special: otmena requires reason (if moving to otmena via drag, we ask reason)
          if (toStatus === "otmena"){
            const reason = prompt("Otmena sababi (sabab):");
            if (!reason) return;
            await api(`/tasks/${id}/cancel`, { method:"POST", body:{ reason } });
            // local update
            patchLocalTask(id, { status:"otmena", cancel_reason: reason, last_change_at: Math.floor(Date.now()/1000) });
          } else {
            await api(`/tasks/${id}/move`, { method:"POST", body:{ status: toStatus } });
            patchLocalTask(id, { status: toStatus, last_change_at: Math.floor(Date.now()/1000) });
            if (toStatus !== "otmena") patchLocalTask(id, { cancel_reason: null });
          }
          renderKanban();
        }catch(err){
          toast("Xatolik", err.message || "Move failed", "danger");
        }
      }

      function moveGhost(x,y){
        if (!S.drag) return;
        S.drag.ghost.style.left = x + "px";
        S.drag.ghost.style.top = y + "px";
      }
    });
  }

  function findColUnder(x,y){
    const el = document.elementFromPoint(x,y);
    if (!el) return null;
    return el.closest(".col");
  }
  function setDragOver(col){
    if (!S.drag) return;
    if (S.drag.lastOver === col) return;
    clearDragOver();
    if (col){
      col.classList.add("dragOver");
      S.drag.lastOver = col;
    }
  }
  function clearDragOver(){
    document.querySelectorAll(".col.dragOver").forEach(c => c.classList.remove("dragOver"));
    if (S.drag) S.drag.lastOver = null;
  }
  function finishDrag(){
    if (!S.drag) return;
    S.drag.ghost.remove();
    document.body.classList.remove("dragging");
    S.drag = null;
  }

  function patchLocalTask(id, patch){
    const t = S.tasks.find(x => x.id === id);
    if (!t) return;
    Object.assign(t, patch);
  }

  // ===== Modals =====
  function openModal(html, {onClose} = {}){
    modalHost.innerHTML = `
      <div class="modalBack" id="mb">
        <div class="modal">${html}</div>
      </div>
    `;
    const back = $("#mb");
    back.addEventListener("click", (e) => {
      if (e.target === back) closeModal();
    });
    function closeModal(){
      modalHost.innerHTML = "";
      if (onClose) onClose();
    }
    return { close: closeModal };
  }

  function openTaskModal(id){
    const t = S.tasks.find(x => x.id === id);
    if (!t) return;

    const now = Math.floor(Date.now()/1000);
    const run = t.status === "jarayonda";
    const runMin = run ? Math.max(0, Math.floor((now - (t.last_change_at || now)) / 60)) : 0;
    const shownSpent = t.spent_min + runMin;

    const canRestore = (S.me.role === "admin" || S.me.role === "pm") && (t.status === "bajarildi" || t.status === "otmena");

    const modal = openModal(`
      <div class="modalHdr">
        <div>
          <h2>${escapeHtml(t.title || "Vazifa")}</h2>
          <small>${escapeHtml(t.code || "")} ¬∑ ${escapeHtml(t.status)}</small>
        </div>
        <button class="btn icon" id="x">‚úï</button>
      </div>

      <div class="rowInfo">
        <span class="chip">üìÖ ${fmtDeadline(t.deadline)}</span>
        <span class="chip ${run ? "run":""}">‚è± ${Math.floor(shownSpent/60)}h ${shownSpent%60}m</span>
        ${t.status === "otmena" && t.cancel_reason ? `<span class="chip bad">üßæ ${escapeHtml(t.cancel_reason)}</span>` : ``}
      </div>

      <div class="field">
        <div class="label">Tavsif</div>
        <div style="padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.06);color:var(--text);min-height:80px">
          ${escapeHtml(t.descr || "‚Äî").replaceAll("\n","<br/>")}
        </div>
      </div>

      <div class="modalActions">
        ${t.status === "jarayonda"
          ? `<button class="btn" id="stopBtn">‚è∏ Stop</button>`
          : `<button class="btn" id="startBtn">‚ñ∂ Start</button>`
        }
        <button class="btn" id="doneBtn">‚úÖ Bajarildi</button>
        <button class="btn danger" id="cancelBtn">‚õî Otmena</button>
        ${canRestore ? `<button class="btn" id="restoreBtn">‚Ü© Qaytarish (Pauza)</button>` : ``}
      </div>
    `);

    $("#x").addEventListener("click", modal.close);

    const startBtn = $("#startBtn");
    if (startBtn){
      startBtn.addEventListener("click", async () => {
        await api(`/tasks/${id}/start`, { method:"POST" });
        patchLocalTask(id, { status:"jarayonda", last_change_at: Math.floor(Date.now()/1000) });
        renderKanban();
        modal.close();
      });
    }
    const stopBtn = $("#stopBtn");
    if (stopBtn){
      stopBtn.addEventListener("click", async () => {
        const r = await api(`/tasks/${id}/stop`, { method:"POST" });
        // minutes_added already added in backend to spent_min; we refresh tasks locally by reloading (safe)
        await loadTasks();
        renderKanban();
        modal.close();
        toast("Stop", `+${r.minutes_added||0} min`, "ok");
      });
    }

    $("#doneBtn").addEventListener("click", async () => {
      await api(`/tasks/${id}/move`, { method:"POST", body:{ status:"bajarildi" } });
      patchLocalTask(id, { status:"bajarildi", last_change_at: Math.floor(Date.now()/1000) });
      renderKanban();
      modal.close();
    });

    $("#cancelBtn").addEventListener("click", async () => {
      const reason = prompt("Otmena sababi (sabab):");
      if (!reason) return;
      await api(`/tasks/${id}/cancel`, { method:"POST", body:{ reason } });
      patchLocalTask(id, { status:"otmena", cancel_reason: reason, last_change_at: Math.floor(Date.now()/1000) });
      renderKanban();
      modal.close();
    });

    const restoreBtn = $("#restoreBtn");
    if (restoreBtn){
      restoreBtn.addEventListener("click", async () => {
        await api(`/tasks/${id}/restore`, { method:"POST" });
        patchLocalTask(id, { status:"pauza", cancel_reason:null, last_change_at: Math.floor(Date.now()/1000) });
        renderKanban();
        modal.close();
      });
    }
  }

  function openTaskCreateModal(){
    const modal = openModal(`
      <div class="modalHdr">
        <div>
          <h2>Yangi vazifa</h2>
          <small>Asosiy maydonlarni kiriting</small>
        </div>
        <button class="btn icon" id="x">‚úï</button>
      </div>

      <div class="modalGrid">
        <div class="field">
          <div class="label">Sarlavha (title)</div>
          <input id="tTitle" class="input" placeholder="Masalan: Hisobot tayyorlash" />
        </div>
        <div class="field">
          <div class="label">Deadline (ixtiyoriy)</div>
          <input id="tDeadline" class="input" type="date" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <div class="label">Tavsif</div>
          <textarea id="tDescr" class="input textarea" placeholder="Batafsil‚Ä¶"></textarea>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn" id="cancel">Bekor</button>
        <button class="btn primary" id="save">Saqlash</button>
      </div>
    `);

    $("#x").addEventListener("click", modal.close);
    $("#cancel").addEventListener("click", modal.close);

    $("#save").addEventListener("click", async () => {
      const title = $("#tTitle").value.trim();
      const descr = $("#tDescr").value.trim();
      const d = $("#tDeadline").value; // yyyy-mm-dd
      let deadline = null;
      if (d){
        const dt = new Date(d + "T00:00:00");
        deadline = Math.floor(dt.getTime()/1000);
      }
      const r = await api("/tasks", { method:"POST", body:{ title, descr, deadline, deal_id:null } });
      toast("OK", `Vazifa yaratildi: ${r.code}`, "ok");
      await loadTasks();
      renderKanban();
      modal.close();
    });
  }

  function makeSelect({label, value, options, onChange, compact=false}){
    const wrap = document.createElement("div");
    wrap.className = "bsel" + (compact ? " compact": "");
    const lab = document.createElement("div");
    lab.className = "label";
    lab.textContent = label;
    const btn = document.createElement("div");
    btn.className = "bselBtn";
    const val = document.createElement("div");
    val.className = "bselVal";
    const caret = document.createElement("div");
    caret.innerHTML = "‚ñæ";
    btn.appendChild(val); btn.appendChild(caret);

    const menu = document.createElement("div");
    menu.className = "bselMenu";

    function set(v){
      value = v;
      const opt = options.find(o => o.value === value) || options[0];
      val.textContent = opt ? opt.label : "";
      menu.querySelectorAll(".bselItem").forEach(x => x.classList.toggle("active", x.dataset.v === String(value)));
    }

    for (const o of options){
      const it = document.createElement("div");
      it.className = "bselItem";
      it.dataset.v = o.value;
      it.innerHTML = `<b>${escapeHtml(o.label)}</b><small style="color:var(--muted)">${escapeHtml(o.small||"")}</small>`;
      it.addEventListener("click", () => {
        set(o.value);
        wrap.classList.remove("open");
        onChange(o.value);
      });
      menu.appendChild(it);
    }

    btn.addEventListener("click", () => wrap.classList.toggle("open"));
    document.addEventListener("click", (e) => { if (!wrap.contains(e.target)) wrap.classList.remove("open"); });

    wrap.appendChild(lab);
    wrap.appendChild(btn);
    wrap.appendChild(menu);
    set(value);
    return wrap;
  }

  // ===== Buttons =====
  $("#loginBtn").addEventListener("click", loginDo);
  $("#logoutBtn").addEventListener("click", logoutDo);

  // Enter to login
  $("#password").addEventListener("keydown", (e) => { if (e.key === "Enter") loginDo(); });

  // ===== Init =====
  checkMe().then(ok => {
    if (!ok) showAuth();
    if (!location.hash) location.hash = "#/tasks";
  });
})();
</script>
</body>
</html>
